# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0

name                    pinentry-mac
github.setup            GPGTools pinentry 1.1.1.1 v
revision                0

categories              aqua security
license                 GPL-3+
maintainers             {ionic @Ionic}
platforms               macosx

description             Cocoa interface for the password entry software pinentry.
long_description        ${description} \
                        It is based on the upstream version of pinentry, adding a \
                        custom interface based on Cocoa for OS X look and feel.

checksums               rmd160 020b63bea209a86435b84379995b3070626627a1 \
                        sha256 8aabf9e04996a88f93d71546e68165bc169e062679348135bf1ba9e95355a9a7 \
                        size   714831

# Utilizes ARC which is x86_64/arm64-only. #45949
supported_archs         x86_64 arm64
installs_libs           no

if { ${os.major} < 12 } {
    known_fail          yes
    pre-fetch {
        ui_error "${subport} @${version} requires macOS 10.8 or later"
        return -code error "incompatible macOS version"
    }
}

use_autoreconf          yes
autoreconf.args         -fiv
use_xcode               yes

depends_lib-append \
                        port:libassuan

configure.args-append \
                        --enable-maintainer-mode \
                        --disable-dependency-tracking \
                        --disable-silent-rules \
                        --disable-libsecret \
                        --disable-ncurses \
                        --disable-pinentry-efl \
                        --disable-pinentry-emacs \
                        --disable-pinentry-gtk2 \
                        --disable-pinentry-gnome3 \
                        --disable-pinentry-fltk \
                        --disable-pinentry-qt \
                        --disable-pinentry-qt5 \
                        --disable-pinentry-tqt

destroot {
    copy ${worksrcpath}/macosx/pinentry-mac.app ${destroot}${applications_dir}/${name}.app
}

notes "
    - If you previously didn't have pinentry or gpg-agent installed\
    and ${name} has been installed as a dependency of gpg-agent,\
    you don't need to do anything to use ${name}.

    - If you want to switch to the gtk2, ncurses, or qt5 based pinentry\
    program, please install pinentry with the desired variant.

    - Follow the instructions below substituting the ${name} program\
    path with ${prefix}/bin/pinentry.

    - If you previously had pinentry and gpg-agent installed and would\
    like to switch to ${name}, you will have to set\
    it as your pinentry program in \$HOME/.gnupg/gpg-agent.conf.

    - Add the following line to the mentioned file:
    pinentry-program ${applications_dir}/${name}.app/Contents/MacOS/${name}

    - Be sure to comment previous \"pinentry-program\" lines, for example:
      pinentry-program SAMPLE
    Becomes:
      #pinentry-program SAMPLE

    Afterwards, run:
      killall -HUP gpg-agent

    Or simply log out and back in again.
"
